---
title: "clean_cdfw"
author: "Lucy Andrews"
date: "9/27/2021"
output: html_document
---


```{r setup}
# set up packages, options, and functions

# load packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(sf))
suppressPackageStartupMessages(library(rgdal))
suppressPackageStartupMessages(library(tigris))
suppressPackageStartupMessages(library(rmapshaper))
suppressPackageStartupMessages(library(ggnewscale))

# set global options
options(stringsAsFactors = FALSE)
options(tigris_use_cache = TRUE)
global_crs <- st_crs(4269)

# build custom functions and operators
# %notin%: operator that returns the negation of %in%
`%notin%` <- Negate(`%in%`)

# paste_na_rm(): function that pastes values together while dropping NAs
paste_na_rm <- function(x, collapse = ", ") {
  
  paste(x[!is.na(x)], collapse = collapse)
  
}

# build is.nan() method for data.frame objects
is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))

# build function that pulls CA boundary into global environment as sf object
get_ca_boundary <- function(crs) {
    states() %>%
      filter(NAME == "California") %>%
      rename(name = NAME) %>%
      select(name) %>%
      st_transform(crs = crs)
}

# build function that quickly pulls up sf object attribute tables
view_flat <- function(sf_obj) {
  st_drop_geometry(sf_obj) %>%
    View(.)
}
```

```{r}
# create directories
if(!dir.exists(here("raw_data", "cdfw_ds734"))) {
  dir.create(here("raw_data", "cdfw_ds734"))
}

if(!dir.exists(here("raw_data", "cdfw_ds168"))) {
  dir.create(here("raw_data", "cdfw_ds168"))
}

# unzip zipped spatial files
unzip(zipfile = here("raw_data", "cdfw_ds734.zip"), overwrite = TRUE,
      exdir = here("raw_data", "cdfw_ds734"))

unzip(zipfile = here("raw_data", "cdfw_ds168.zip"), overwrite = TRUE,
      exdir = here("raw_data", "cdfw_ds168"))

# read in files as sf objects
# ds734: boundary regions for fisheries restoration grant program
# multipolygon
ds734 <- st_read(dsn = here("raw_data", "cdfw_ds734", "ds734.shp")) %>%
  st_transform(crs = global_crs)

# ds168: locations of fisheries restoration grant program projects
ds168 <- readOGR(dsn = here("raw_data", "cdfw_ds168", "ds168.gdb"), layer = "ds168") %>%
  st_as_sf() %>%
  st_transform(crs = global_crs)
```

```{r}
# clean data
ds734 <- ds734 %>%
  rename(region = REGION,
         sub_region = SUBREGION,
         basin = BASIN,
         sub_basin = SUBBASIN,
         huc2 = HUC_2,
         huc4 = HUC_4,
         huc6 = HUC_6,
         huc8 = HUC_8,
         acres = ACRES,
         sq_miles = SQ_MILES,
         state_huc8 = HU_8_STATE,
         fips = FIPS_C,
         huc10_name = HU_10_NAME,
         huc10_sq_miles = HUC10_SqMi,
         llid = LLID,
         name = NAME,
         length_ft = LENGTH_FT,
         mouth = MOUTH,
         area_sq_miles = AREA_sq_mi)

ds168 <- ds168 %>%
  rename(project_id = ProjectID,
         worksite_id = WorksiteID,
         worksite_name = WorksiteNa,
         award_year = Award_Year) %>%
  select(-WorksiteLa, - WorksiteLo)
```

```{r}
ca_boundary <- get_ca_boundary(crs = global_crs)

ggplot() +
  geom_sf(data = ca_boundary, fill = "lightgrey") +
  geom_sf(data = ds734, fill = "lightblue") +
  geom_sf(data = ds168, aes(color = award_year)) +
  theme_minimal()
```

