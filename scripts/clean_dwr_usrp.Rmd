---
title: "clean_dwr_usrp"
author: "Lucy Andrews"
date: "9/21/2021"
output: html_document
---

```{r setup}
# set up packages, options, and functions

# load packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(magrittr))
suppressPackageStartupMessages(library(janitor))
suppressPackageStartupMessages(library(here))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(sf))

# set global options
options(stringsAsFactors = FALSE)

# build custom functions and operators
# %notin%: operator that returns the negation of %in%
`%notin%` <- Negate(`%in%`)

# paste_na_rm(): function that pastes values together while dropping NAs
paste_na_rm <- function(x, collapse = ", ") {
  
  paste(x[!is.na(x)], collapse = collapse)
  
}

# build is.nan() method for data.frame objects
is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))
```

```{r}
# import all data

# import data - usrp_all_projects.xlsx --> All Projects sheet
attr_colnames <- c("project_num", "project_name", "year_awarded",
                   "funding_source", "sponsor", "co_sponsor", "project_desc",
                   "funding_amount", "total_project_cost", "county", "latitude",
                   "longitude")

usrp_all_projects_attr <- read_excel(here("raw_data", "usrp_all_projects.xlsx"),
                                     sheet = "All Projects",
                                     col_names = attr_colnames,
                                     col_types = "text",
                                     skip = 1) %>%
  mutate(year_awarded = substr(year_awarded, 1, 4),
         funding_amount = as.numeric(funding_amount),
         total_project_cost = as.numeric(total_project_cost),
         latitude = as.numeric(latitude),
         longitude = as.numeric(longitude)) %>%
  remove_empty(which = "cols") %>%
  distinct()

# import data - usrp_all_projects.xlsx --> Location sheet
loc_colnames <- c("project_num", "project_name", "project_address_desc", "city",
                  "zip_code", "county", "huc8", "lat", "long", "latitude",
                  "longitude", "restored_length")

usrp_all_projects_loc <- read_excel(here("raw_data", "usrp_all_projects.xlsx"),
                                    sheet = "Location",
                                    col_names = loc_colnames,
                                    col_types = "text",
                                    skip = 1) %>%
  remove_empty(which = "cols") %>%
  distinct()

# clean up environment
rm(attr_colnames, loc_colnames)
```

```{r}
# clean the attributes dataframe

# deal with projects without a project ID number
# so that the location table can be joined without NA record duplication issues
# first create a sequence of incrementing ID numbers with the prefix X
seq_fill_na <- paste0("X-attr-", seq(from = 1,
                                     to = sum(is.na(usrp_all_projects_attr$project_num)),
                                     by = 1))

# grab records with NA project numbers
# and replace NAs with incremental project numbers
usrp_all_projects_attr_na <- usrp_all_projects_attr %>%
  filter(is.na(project_num)) %>%
  mutate(project_num = seq_fill_na)

# rebind fixed records to original dataframe
usrp_all_projects_attr <- usrp_all_projects_attr %>%
  filter(!is.na(project_num)) %>%
  rbind(usrp_all_projects_attr_na)

# clean duplicate records
# duplicates identified as records sharing a project number
usrp_all_projects_attr <- usrp_all_projects_attr %>%
  group_by(project_num) %>%
  summarize(project_name = paste_na_rm(project_name, collapse = ", "),
            year_awarded = min(year_awarded),
            funding_source = paste_na_rm(funding_source, collapse = ", "),
            sponsor = paste_na_rm(sponsor, collapse = ", "),
            co_sponsor = paste_na_rm(co_sponsor, collapse = ", "),
            project_desc = paste_na_rm(project_desc, collapse = "; "),
            funding_amount = sum(funding_amount, na.rm = TRUE),
            total_project_cost = sum(funding_amount, na.rm = TRUE),
            county = paste_na_rm(county, collapse = ", "),
            latitude = mean(latitude, na.rm = TRUE),
            longitude = mean(longitude, na.rm = TRUE))

# clean up NA and NaN values
usrp_all_projects_attr[usrp_all_projects_attr == ""] <- NA
usrp_all_projects_attr[is.nan(usrp_all_projects_attr)] <- NA

# clean up environment
rm(seq_fill_na, usrp_all_projects_attr_na)
```

```{r warning = FALSE}
# clean the locations dataframe

# grab records with NA project numbers
usrp_all_projects_loc_na <- usrp_all_projects_loc %>%
  filter(is.na(project_num))

# create sequence of ID numbers to fill NA values
seq_fill_na <- paste0("X-loc-", seq(from = 1,
                                    to = sum(is.na(usrp_all_projects_loc_na$project_num)),
                                    by = 1))

# replace NAs with incremental project numbers
usrp_all_projects_loc_na <- usrp_all_projects_loc_na %>%
  mutate(project_num = seq_fill_na)

# remove records with NA project numbers
usrp_all_projects_loc <- usrp_all_projects_loc %>%
  filter(!is.na(project_num))

# drop duplicate records - most attributes are NA so going with quick !duplicated
usrp_all_projects_loc <- usrp_all_projects_loc %>%
  distinct(project_num, .keep_all = TRUE)

# clean latitude data
usrp_all_projects_loc <- usrp_all_projects_loc %>%
  # separate latitude column into two columns on "," and ";" delimiters
  # for elements with both latitude and longitude listed in the latitude field
  separate(col = latitude, into = c("latitude_cleaned", "longitude_working"), sep = "[,;]") %>%
  # drop all non-numeric characters
  mutate(latitude_cleaned = gsub(pattern = "\\D+", replacement = "", latitude_cleaned),
         # insert period after second character
         latitude_cleaned = case_when(is.na(latitude_cleaned) ~ NA_character_,
                                      str_length(latitude_cleaned) > 2 ~
                                        paste0(str_sub(latitude_cleaned, 1, 2),
                                               ".",
                                               str_sub(latitude_cleaned, 3, -1))),
         # convert to numeric
         latitude_cleaned = as.numeric(latitude_cleaned),
         # replace out-of-bbox values with NA
         latitude_cleaned = case_when(latitude_cleaned > 42.1 ~ NA_real_,
                                      TRUE ~ latitude_cleaned))


# clean longitude data
usrp_all_projects_loc <- usrp_all_projects_loc %>%
  # merge longitude and longitude_working fields into single field
  mutate(longitude_cleaned = case_when(!is.na(longitude_working) ~ longitude_working,
                                       !is.na(longitude) ~ longitude,
                                       TRUE ~ NA_character_),
         # drop all non-numeric characters
         longitude_cleaned = gsub(pattern = "\\D+", replacement = "", longitude_cleaned),
         # insert period after third character
         longitude_cleaned = case_when(is.na(longitude_cleaned) ~ NA_character_,
                                      str_length(longitude_cleaned) > 2 ~
                                        paste0(str_sub(longitude_cleaned, 1, 3),
                                               ".",
                                               str_sub(longitude_cleaned, 4, -1))),
         # convert to integer and format direction of longitude coordinate
         longitude_cleaned = -1 * as.numeric(longitude_cleaned),
         # drop longitude coordinates without paired latitude coordinate
         longitude_cleaned = case_when(is.na(latitude_cleaned) ~ NA_real_,
                                       TRUE ~ longitude_cleaned)) %>%
  # clean up column order
  select(everything(), -latitude_cleaned, -longitude_cleaned, -longitude, -longitude_working,
         latitude_cleaned, longitude_cleaned) %>%
  # clean up column names
  rename(latitude = latitude_cleaned,
         longitude = longitude_cleaned)

# clean up records with data in wrong fields
usrp_all_projects_loc_na <- usrp_all_projects_loc_na %>%
  mutate(latitude = as.numeric(city),
         longitude = as.numeric(zip_code),
         restored_length = county,
         city = NA_character_,
         zip_code = NA_character_,
         county = NA_character_) %>%
  select(everything(), -latitude, -longitude, latitude, longitude)

# create single dataframe
usrp_all_projects_loc <- rbind(usrp_all_projects_loc, usrp_all_projects_loc_na)

# clean up
rm(usrp_all_projects_loc_na, seq_fill_na)
```

```{r}
# create a single dataframe with all attributes
usrp_all_projects <- full_join(x = usrp_all_projects_attr,
                               y = usrp_all_projects_loc,
                               by = c("project_num", "project_name"),
                               suffix = c("_attr", "_loc")) %>%
  arrange(desc(funding_amount)) %>%
  distinct(project_num, .keep_all = TRUE)

# clean up
rm(usrp_all_projects_attr, usrp_all_projects_loc)
```

```{r}

```

